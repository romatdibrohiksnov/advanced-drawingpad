<!DOCTYPE html>
<html>
<head>
    <title>Roguelike 游戏</title>
    <style>
        body {
            background: #000;
            color: #fff;
            font-family: monospace;
        }
        #game {
            white-space: pre;
            font-size: 20px;
        }
        .status {
            position: fixed;
            top: 10px;
            right: 10px;
            white-space: pre-line;
        }
        .info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            color: #888;
            white-space: pre-line;
        }
    </style>
</head>
<body>
    <pre id="game"></pre>
    <div class="status" id="status"></div>
    <div class="info" id="info"></div>

<script>
const Game = {
    mapSize: 20,
    player: {
        x: 10,
        y: 10,
        hp: 100,
        maxHp: 100,
        atk: 20,
        def: 5,
        gold: 100
    },
    currentEnemy: null,
    inShop: false,
    map: [],
    messages: [],

    init() {
        this.generateMap();
        this.updateStatus();
        this.addMessage("欢迎来到地牢！使用方向键移动");
        document.addEventListener('keydown', (e) => this.handleInput(e));
    },

    generateMap() {
        // 生成基础地图
        for (let y = 0; y < this.mapSize; y++) {
            this.map[y] = [];
            for (let x = 0; x < this.mapSize; x++) {
                this.map[y][x] = Math.random() > 0.3 ? '.' : '#';
            }
        }

        // 放置游戏元素
        this.placeRandom('M'); // 怪物
        this.placeRandom('$'); // 商店
        this.placeRandom('P'); // 药水
        this.map[this.player.y][this.player.x] = '@';
    },

    placeRandom(char) {
        for (let i = 0; i < 5; i++) {
            let x, y;
            let attempts = 0;
            do {
                x = Math.floor(Math.random() * this.mapSize);
                y = Math.floor(Math.random() * this.mapSize);
                attempts++;
                if (attempts > 100) break;
            } while (this.map[y][x] !== '.');
            if (this.map[y][x] === '.') {
                this.map[y][x] = char;
            }
        }
    },

    updateStatus() {
        const status = document.getElementById('status');
        status.innerHTML = `HP: ${this.player.hp}/${this.player.maxHp}\n攻击: ${this.player.atk}\n防御: ${this.player.def}\n金币: ${this.player.gold}`;
    },

    addMessage(msg) {
        this.messages.push(msg);
        if (this.messages.length > 5) this.messages.shift();
        document.getElementById('info').innerHTML = this.messages.join('\n');
    },

    handleInput(e) {
        if (this.currentEnemy) return this.handleCombat(e);
        if (this.inShop) return;
        
        const key = e.key;
        let dx = 0, dy = 0;
        if (key === 'ArrowUp') dy = -1;
        else if (key === 'ArrowDown') dy = 1;
        else if (key === 'ArrowLeft') dx = -1;
        else if (key === 'ArrowRight') dx = 1;
        
        if (dx || dy) {
            this.movePlayer(dx, dy);
        }
    },

    movePlayer(dx, dy) {
        const newX = this.player.x + dx;
        const newY = this.player.y + dy;
        
        if (newX >= 0 && newX < this.mapSize && 
            newY >= 0 && newY < this.mapSize) {
            
            const cell = this.map[newY][newX];
            if (cell !== '#') {
                const allowMove = this.handleCellEvent(cell, newX, newY);
                if (allowMove) {
                    this.map[this.player.y][this.player.x] = '.';
                    this.player.x = newX;
                    this.player.y = newY;
                    this.map[newY][newX] = '@';
                }
            }
        }
        this.render();
    },

    handleCellEvent(cell, x, y) {
        let allowMove = true;
        switch(cell) {
            case 'M':
                this.startCombat(x, y);
                allowMove = false;
                break;
            case '$':
                this.showShop();
                break;
            case 'P':
                this.player.hp = Math.min(this.player.maxHp, this.player.hp + 30);
                this.map[y][x] = '.';
                this.addMessage("你找到了治疗药水！恢复30HP");
                break;
        }
        return allowMove;
    },

    startCombat(x, y) {
        this.currentEnemy = {
            x: x,
            y: y,
            hp: 50 + Math.floor(Math.random() * 50),
            atk: 15 + Math.floor(Math.random() * 10),
            def: 3 + Math.floor(Math.random() * 5)
        };
        this.addMessage(`遭遇怪物！(HP:${this.currentEnemy.hp} ATK:${this.currentEnemy.atk})`);
    },

    handleCombat(e) {
        if (e.key === '1') {
            this.playerAttack();
        } else if (e.key === '2' && this.player.gold >= 50) {
            this.player.hp += 50;
            this.player.gold -= 50;
            this.addMessage("使用金币治疗！恢复50HP");
            this.enemyAttack();
        }
        this.updateStatus();
    },

    playerAttack() {
        const damage = Math.max(0, this.player.atk - this.currentEnemy.def);
        this.currentEnemy.hp -= damage;
        this.addMessage(`你造成 ${damage} 点伤害`);
        this.checkCombatEnd();
        if (this.currentEnemy) this.enemyAttack();
    },

    enemyAttack() {
        const damage = Math.max(0, this.currentEnemy.atk - this.player.def);
        this.player.hp -= damage;
        this.addMessage(`怪物造成 ${damage} 点伤害`);
        this.checkCombatEnd();
    },

    checkCombatEnd() {
        if (this.currentEnemy && this.currentEnemy.hp <= 0) {
            this.addMessage("你击败了怪物！获得50金币");
            this.player.gold += 50;
            this.map[this.currentEnemy.y][this.currentEnemy.x] = '.';
            this.currentEnemy = null;
        }
        if (this.player.hp <= 0) {
            alert("游戏结束！");
            location.reload();
        }
    },

    showShop() {
        this.inShop = true;
        this.addMessage("商店: 1. 生命药水(50金) 2. 强化攻击(100金)");
        const shopListener = (e) => {
            if (e.key === '1') {
                if (this.player.gold >= 50) {
                    this.player.maxHp += 20;
                    this.player.gold -= 50;
                    this.addMessage("购买生命药水！最大HP+20");
                    this.updateStatus();
                }
                this.inShop = false;
                document.removeEventListener('keydown', shopListener);
            } else if (e.key === '2') {
                if (this.player.gold >= 100) {
                    this.player.atk += 10;
                    this.player.gold -= 100;
                    this.addMessage("强化攻击！攻击+10");
                    this.updateStatus();
                }
                this.inShop = false;
                document.removeEventListener('keydown', shopListener);
            }
        };
        document.addEventListener('keydown', shopListener);
    },

    render() {
        const game = document.getElementById('game');
        game.innerHTML = this.map.map(row => row.join('')).join('\n');
    }
};

Game.init();
Game.render();
</script>
</body>
</html>