<!DOCTYPE html>
<html>
<head>
    <title>Roguelike 游戏</title>
    <style>
        body {
            background: #000;
            color: #fff;
            font-family: monospace;
        }
        #game {
            white-space: pre;
            font-size: 20px;
        }
        .status {
            position: fixed;
            top: 10px;
            right: 10px;
        }
        .info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            color: #888;
        }
    </style>
</head>
<body>
    <pre id="game"></pre>
    <div class="status" id="status"></div>
    <div class="info" id="info"></div>

<script>
const Game = {
    mapSize: 20,
    player: {
        x: 10,
        y: 10,
        hp: 100,
        maxHp: 100,
        atk: 20,
        def: 5,
        gold: 100
    },
    currentEnemy: null,
    map: [],
    messages: [],

    init() {
        this.generateMap();
        this.updateStatus();
        this.addMessage("欢迎来到地牢！使用方向键移动");
        document.addEventListener('keydown', (e) => this.handleInput(e));
    },

    generateMap() {
        // 生成基础地图
        for (let y = 0; y < this.mapSize; y++) {
            this.map[y] = [];
            for (let x = 0; x < this.mapSize; x++) {
                this.map[y][x] = Math.random() > 0.3 ? '.' : '#';
            }
        }

        // 放置游戏元素
        this.placeRandom('M'); // 怪物
        this.placeRandom('$'); // 商店
        this.placeRandom('P'); // 药水
        this.map[this.player.y][this.player.x] = '@';
    },

    placeRandom(char) {
        for (let i = 0; i < 5; i++) {
            let x, y;
            do {
                x = Math.floor(Math.random() * this.mapSize);
                y = Math.floor(Math.random() * this.mapSize);
            } while (this.map[y][x] !== '.');
            this.map[y][x] = char;
        }
    },

    updateStatus() {
        const status = document.getElementById('status');
        status.innerHTML = `HP: ${this.player.hp}/${this.player.maxHp}

                           攻击: ${this.player.atk}

                           防御: ${this.player.def}

                           金币: ${this.player.gold}`;
    },

    addMessage(msg) {
        this.messages.push(msg);
        if (this.messages.length > 5) this.messages.shift();
        document.getElementById('info').innerHTML = this.messages.join('
');
    },

    handleInput(e) {
        if (this.currentEnemy) return this.handleCombat(e);
        
        const key = e.key;
        let dx = 0, dy = 0;
        if (key === 'ArrowUp') dy = -1;
        else if (key === 'ArrowDown') dy = 1;
        else if (key === 'ArrowLeft') dx = -1;
        else if (key === 'ArrowRight') dx = 1;
        
        if (dx || dy) {
            this.movePlayer(dx, dy);
        }
    },

    movePlayer(dx, dy) {
        const newX = this.player.x + dx;
        const newY = this.player.y + dy;
        
        if (newX >= 0 && newX < this.mapSize && 
            newY >= 0 && newY < this.mapSize) {
            
            const cell = this.map[newY][newX];
            this.handleCellEvent(cell, newX, newY);
            
            if (cell !== '#') {
                this.map[this.player.y][this.player.x] = '.';
                this.player.x = newX;
                this.player.y = newY;
                this.map[newY][newX] = '@';
            }
        }
        this.render();
    },

    handleCellEvent(cell, x, y) {
        switch(cell) {
            case 'M':
                this.startCombat(x, y);
                break;
            case '$':
                this.showShop();
                break;
            case 'P':
                this.player.hp = Math.min(this.player.maxHp, this.player.hp + 30);
                this.map[y][x] = '.';
                this.addMessage("你找到了治疗药水！恢复30HP");
                break;
        }
    },

    startCombat(x, y) {
        this.currentEnemy = {
            hp: 50 + Math.floor(Math.random() * 50),
            atk: 15 + Math.floor(Math.random() * 10),
            def: 3 + Math.floor(Math.random() * 5)
        };
        this.addMessage(`遭遇怪物！(HP:${this.currentEnemy.hp} ATK:${this.currentEnemy.atk})`);
    },

    handleCombat(e) {
        if (e.key === '1') this.playerAttack();
        else if (e.key === '2' && this.player.gold >= 50) {
            this.player.hp += 50;
            this.player.gold -= 50;
            this.addMessage("使用金币治疗！恢复50HP");
        }
        this.enemyAttack();
        this.checkCombatEnd();
        this.updateStatus();
    },

    playerAttack() {
        const damage = Math.max(0, this.player.atk - this.currentEnemy.def);
        this.currentEnemy.hp -= damage;
        this.addMessage(`你造成 ${damage} 点伤害`);
    },

    enemyAttack() {
        const damage = Math.max(0, this.currentEnemy.atk - this.player.def);
        this.player.hp -= damage;
        this.addMessage(`怪物造成 ${damage} 点伤害`);
    },

    checkCombatEnd() {
        if (this.currentEnemy.hp <= 0) {
            this.addMessage("你击败了怪物！获得50金币");
            this.player.gold += 50;
            this.currentEnemy = null;
        }
        if (this.player.hp <= 0) {
            alert("游戏结束！");
            location.reload();
        }
    },

    showShop() {
        this.addMessage("商店: 1. 生命药水(50金) 2. 强化攻击(100金)");
        document.addEventListener('keydown', function shopListener(e) {
            if (e.key === '1' && this.player.gold >= 50) {
                this.player.maxHp += 20;
                this.player.gold -= 50;
                this.addMessage("购买生命药水！最大HP+20");
            }
            else if (e.key === '2' && this.player.gold >= 100) {
                this.player.atk += 10;
                this.player.gold -= 100;
                this.addMessage("强化攻击！攻击+10");
            }
            document.removeEventListener('keydown', shopListener);
        }.bind(this));
    },

    render() {
        const game = document.getElementById('game');
        game.innerHTML = this.map.map(row => row.join('')).join('\n');
    }
};

Game.init();
Game.render();
</script>
</body>
</html>